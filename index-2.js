const axios = require('axios');
const TelegramBot = require('node-telegram-bot-api');
const express = require('express');

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const TELEGRAM_BOT_TOKEN = '7597119999:AAEg3uDHxQt1mURsuwMoLKdkAvsDlFupzaM'; // –¢–æ–∫–µ–Ω –±–æ—Ç–∞
const SHOP_ID = 'your_shop_id'; // ID –º–∞–≥–∞–∑–∏–Ω–∞ –≤ –ÆKassa
const API_KEY = 'your_api_key'; // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á API –ÆKassa
const CHANNEL_ID = '@your_channel_username'; // Username –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID –∫–∞–Ω–∞–ª–∞

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TelegramBot(TELEGRAM_BOT_TOKEN, { polling: true });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –ÆKassa
async function createPayment(chatId, amount, description) {
    const url = 'https://api.yookassa.ru/v3/payments';
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Basic ${Buffer.from(`${SHOP_ID}:${API_KEY}`).toString('base64')}`
    };
    const payload = {
        amount: {
            value: amount,
            currency: "RUB"
        },
        confirmation: {
            type: "redirect",
            return_url: "https://t.me/your_bot_username" // URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
        },
        description: description,
        metadata: {
            chat_id: chatId // –°–æ—Ö—Ä–∞–Ω—è–µ–º chatId –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        }
    };

    try {
        const response = await axios.post(url, payload, { headers });
        return response.data;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞:', error.response ? error.response.data : error.message);
        throw error;
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, async (msg) => {
    const chatId = msg.chat.id;
    const userName = msg.from.first_name || '–î—Ä—É–≥'; // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ "–î—Ä—É–≥", –µ—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

    // –¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    const welcomeMessage = `
${userName} üëã

–û—Ç –∏–¥–µ–∏ –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ 

–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –≤–∞—Å –∫ –Ω–∞—à–µ–º—É –∫–∞–Ω–∞–ª—É ¬´–û—Ç –∏–¥–µ–∏ –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏¬ª, –ø–æ—Å–≤—è—â–µ–Ω–Ω–æ–º—É –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –±–ª–æ–≥–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏—é —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Å–≤–æ–∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ –∏–¥–µ–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å, –∏–∑—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∏ –Ω–∞–ª–∞–¥–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ —Å –±—Ä–µ–Ω–¥–∞–º–∏, –≤—ã –ø–æ–ø–∞–ª–∏ –ø–æ –∞–¥—Ä–µ—Å—É ü´∂üèº

–ö–∞–Ω–∞–ª —Å—Ç–∞–Ω–µ—Ç –≤–∞—à–∏–º –Ω–∞–¥–µ–∂–Ω—ã–º —Å–ø—É—Ç–Ω–∏–∫–æ–º –≤ –º–∏—Ä–µ –±–ª–æ–≥–∏–Ω–≥–∞.

–í –Ω–µ–º —è –±—É–¥—É –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –ø–æ–ª–µ–∑–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è, —É—Å–ø–µ—à–Ω—ã–º–∏ –∫–µ–π—Å–∞–º–∏ –∏ –º–Ω–æ–≥–∏–º–∏ –¥—Ä—É–≥–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≤–∞–º —Å–æ–∑–¥–∞—Ç—å –∏ —Ä–∞–∑–≤–∏—Ç—å –≤–∞—à –±–ª–æ–≥.

–ï—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –∫–∞–∫–∏–µ —Ç–µ–º—ã –º—ã –∑–∞—Ç—Ä–æ–Ω–µ–º: 
- –ö–∞–∫ —Å–¥–≤–∏–Ω—É—Ç—å —Å–≤–æ–π –±–ª–æ–≥ —Å –º–µ—Ä—Ç–≤–æ–π —Ç–æ—á–∫–∏ 
- –ö–∞–∫ –Ω–∞—á–∞—Ç—å –Ω–∞–±–∏—Ä–∞—Ç—å —Ö–æ—Ä–æ—à–∏–µ –æ—Ö–≤–∞—Ç—ã –∏ –Ω–æ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é 
- –ö–∞–∫ –≤—ã–π—Ç–∏ –Ω–∞ –±–∞—Ä—Ç–µ—Ä–Ω–æ–µ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ —Å –±—Ä–µ–Ω–¥–∞–º–∏ 
- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–ª–≥–æ—Ä–∏—Ç–º—ã, –∫–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç 
- –ü–æ–¥–±–æ—Ä–∫–∏ –∏–¥–µ–π –¥–ª—è —Ä–∏–ª—Å –∫–æ—Ç–æ—Ä—ã–µ –≤ —Ç—Ä–µ–Ω–¥–µ 
- –ú–æ–Ω—Ç–∞–∂, –æ–±—Ä–∞–±–æ—Ç–∫–∞, —à—Ä–∏—Ñ—Ç—ã, –º—É–∑—ã–∫–∞, —Å—Ç–∏–∫–µ—Ä—ã, –ø—Ä–µ—Å–µ—Ç—ã, –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ 
- –ö–∞–∫–∏–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º —è –ø–æ–ª—å–∑—É—é—Å—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚ù§Ô∏è‚Äçüî•
- –ú–æ–π –æ–ø—ã—Ç, –º–æ—ë –º–Ω–µ–Ω–∏–µ, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –∏ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç 
- –†–∞–∑–±–æ—Ä –æ—à–∏–±–æ–∫ –≤ –±–ª–æ–≥–∞—Ö 
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å 

–û—Ñ–æ—Ä–º–ª—è–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å —á–∞—Å—Ç—å—é –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∏ –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö –ª—é–¥–µ–π.
‚Äî –æ—Ç –∏–¥–µ–∏ –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!

üî∏ –¥–æ—Å—Ç—É–ø: –ù–ê–í–°–ï–ì–î–ê 
üî∏ —Ñ–æ—Ä–º–∞—Ç: –ø–æ–¥–∫–∞—Å—Ç—ã, —Å—Ç–∞—Ç—å–∏, —É—Ä–æ–∫–∏
`;

    // –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const imageUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqnha6aszARla9NiFlyeSV7H6MFxmE_o_h8A&s'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    await bot.sendPhoto(chatId, imageUrl);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã
    bot.sendMessage(chatId, welcomeMessage, {
        reply_markup: {
            inline_keyboard: [
                [{ text: "–û–ø–ª–∞—Ç–∏—Ç—å 100‚ÇΩ", callback_data: "pay_100" }]
            ]
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç—å"
bot.on('callback_query', async (query) => {
    const chatId = query.message.chat.id;

    if (query.data === "pay_100") {
        try {
            // –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂
            const paymentData = await createPayment(chatId, "100.00", "–î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É –∫–∞–Ω–∞–ª—É");

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
            bot.sendMessage(chatId, `–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã: ${paymentData.confirmation.confirmation_url}`);
        } catch (error) {
            bot.sendMessage(chatId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }
    }
});

// Webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa
const app = express();
app.use(express.json());

app.post('/webhook', async (req, res) => {
    const event = req.body;

    if (event.event === "payment.succeeded") {
        const chatId = event.object.metadata.chat_id;

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª
        try {
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
            await bot.sendMessage(chatId, "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É.");

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª
            await bot.inviteChatMember(CHANNEL_ID, chatId);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª:', error);
            bot.sendMessage(chatId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–∞—Å –≤ –∫–∞–Ω–∞–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.");
        }
    }

    res.sendStatus(200);
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(3000, () => {
    console.log('–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000');
});